<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reserva – Tiendita BMM</title>

  <style>
    :root {
      --azul: #0d1c84;
      --gris: #eef0ff;
      --radio: 12px;
      --sombra: 0 2px 8px rgba(0, 0, 0, .12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      min-height: 100vh
    }

    header {
      background: #fff;
      box-shadow: var(--sombra);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10
    }

    header img {
      height: 28px
    }

    header span {
      font-weight: 600;
      font-size: 18px
    }

    main {
      flex: 1;
      max-width: 900px;
      margin: 30px auto;
      padding: 0 15px;
      text-align: center
    }

    h1 {
      color: var(--azul);
      font-size: 28px;
      margin: 18px 0 4px;
      text-transform: capitalize
    }

    h2 {
      color: var(--azul);
      margin: 6px 0 26px;
      font-size: 22px
    }

    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px
    }

    .nav-btn {
      width: 34px;
      height: 34px;
      border: none;
      border-radius: var(--radio);
      background: var(--gris);
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background .2s
    }

    .nav-btn:not(:disabled):hover {
      background: #d0d1e6
    }

    .nav-btn:disabled {
      background: #dcdde7;
      color: #999;
      cursor: not-allowed
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      justify-content: center
    }

    .day-header,
    .day {
      padding: 8px;
      text-align: center;
      border-radius: var(--radio)
    }

    .day-header {
      font-weight: 700;
      background: var(--gris)
    }

    .day {
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      border: 1px solid #c6c9e6;
      background: #e7ffe7;
      cursor: pointer;
    }

    .day.medium {
      background: #fff4bf
    }

    .day.full {
      background: #ffd6d6
    }

    .day.disabled {
      background: #f1f1f1;
      color: #999;
      cursor: not-allowed
    }

    .selected {
      outline: 2px solid var(--azul)
    }

    @media(max-width:600px) {
      .day {
        min-height: 55px;
        font-size: 14px
      }
    }

    .slots {
      margin-top: 30px;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(6, 1fr)
    }

    .slot-btn {
      width: 100%;
      padding: 10px 0;
      border: none;
      border-radius: var(--radio);
      background: var(--azul);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: filter .15s
    }

    .slot-btn:hover {
      filter: brightness(1.1)
    }

    .slot-btn[disabled] {
      background: #ccc;
      color: #666;
      cursor: not-allowed
    }

    @media(max-width:750px) {
      .slots {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    @media(max-width:520px) {
      .slots {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100
    }

    .modal {
      background: #fff;
      padding: 24px;
      border-radius: var(--radio);
      box-shadow: var(--sombra);
      max-width: 420px;
      width: 90%;
      text-align: center
    }

    .modal h3 {
      margin-bottom: 15px;
      color: var(--azul)
    }

    .modal button {
      padding: 14px 26px;
      border: none;
      border-radius: var(--radio);
      font-weight: 700;
      font-size: 16px;
      cursor: pointer
    }

    .btn-ok {
      background: #24a148;
      color: #fff;
      margin-right: 14px
    }

    .btn-cancel {
      background: #d82c0d;
      color: #fff
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px
    }

    .close-modal {
      width: 34px;
      height: 34px;
      border: none;
      border-radius: var(--radio);
      background: var(--gris);
      font-size: 20px;
      font-weight: bold;
      line-height: 0;
      cursor: pointer
    }

    .close-modal:hover {
      background: #d0d1e6
    }

    .modal-scroll {
      max-height: 60vh;
      overflow-y: auto;
      text-align: left;
      padding-right: 6px;
      margin-top: 4px
    }

    #spinner {
      display: none;
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      font-size: 17px
    }

    footer {
      background: var(--azul);
      color: #fff;
      text-align: center;
      padding: 18px 10px;
      font-size: 14px
    }

    footer a {
      color: #fff;
      text-decoration: underline
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>

<body>
  <header>
    <img src="img/sitelogo.png" alt="Logo">
    <span>Mi Tiendita</span>
  </header>

  <main>
    <div class="month-nav">
      <button id="prevBtn" class="nav-btn">◀</button>
      <div>
        <h1 id="mes"></h1>
        <h2>Selecciona tu cita</h2>
      </div>
      <button id="nextBtn" class="nav-btn">▶</button>
    </div>

    <div id="calendar" class="calendar"></div>
    <div id="slots" class="slots"></div>
    <div id="spinner">⏳ Guardando cita…</div>
  </main>

  <footer>
    © 2025 Tiendita BMM |
    <a href="javascript:void(0)" onclick="mostrarAviso()">Aviso de Privacidad</a>
  </footer>

  <script>

    firebase.initializeApp({
      apiKey: "AIzaSyDvHy46iATTlnwpOgWgSib2Tm43SJPkjzY",
      authDomain: "registrotienditabmm.firebaseapp.com",
      projectId: "registrotienditabmm"
    });
    const db = firebase.firestore();


    const MAX_CUPOS = 3;
    const EXT_URL = "https://script.google.com/macros/s/AKfycbxWb0PRv7NCFlDnoBt6ys5hEbxXKVBxJa0iMN5wP8PEOwLJQopgadQRcgyu_Yd0n38t/exec";

    const today = new Date();
    let currentOffset = 0;
    let HORAS = [], FESTIVOS = [], reservas = {};


    const $ = id => document.getElementById(id);
    const pad = n => String(n).padStart(2, "0");
    const cleanHour = h => (h || "").match(/\d{2}:\d{2}/)?.[0] || "";


    const user = JSON.parse(localStorage.getItem("registroTiendita") || "null");
    if (!user || !user.nombre) { alert("Debes registrarte primero"); location.href = "index.html"; }


    (async () => {
      const hSnap = await db.doc("config/horarios").get();
      HORAS = (hSnap.exists ? hSnap.data().slots : []).map(cleanHour);
      if (!HORAS.length) HORAS = generarHoras("13:00", "16:50", 10);

      const fSnap = await db.doc("config/festivos").get();
      FESTIVOS = fSnap.exists ? fSnap.data().fechas || [] : [];

      await refrescarReservas();
      render();
    })();


    $("prevBtn").onclick = () => { if (currentOffset > 0) { currentOffset--; render(); } };
    $("nextBtn").onclick = () => { if (currentOffset < 1) { currentOffset++; render(); } };

    function updateNavBtns() {
      $("prevBtn").disabled = currentOffset === 0;
      $("nextBtn").disabled = currentOffset === 1;
    }


    function render() {
      drawCalendar();
      $("slots").innerHTML = "";
      updateNavBtns();
    }

    function drawCalendar() {
      const cal = $("calendar"); cal.innerHTML = "";
      const base = new Date(today.getFullYear(), today.getMonth() + currentOffset, 1);
      const year = base.getFullYear(), month = base.getMonth();

      $("mes").textContent = base.toLocaleString("es", { month: "long", year: "numeric" });

      ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"].forEach(d => {
        const th = document.createElement("div"); th.className = "day-header"; th.textContent = d; cal.appendChild(th);
      });

      const offset = (new Date(year, month, 1).getDay() + 6) % 7;
      const days = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < offset; i++) cal.appendChild(disabledCell());

      for (let d = 1; d <= days; d++) {
        const iso = `${year}-${pad(month + 1)}-${pad(d)}`;
        const cell = document.createElement("div");
        cell.className = "day"; cell.textContent = d;

        const weekend = [0, 6].includes(new Date(year, month, d).getDay());
        const beforeToday = currentOffset === 0 && iso < today.toISOString().split("T")[0];
        if (weekend || FESTIVOS.includes(iso) || beforeToday) {
          cell.classList.add("disabled");
        } else {
          const taken = Object.values(reservas[iso] || {}).reduce((a, b) => a + b, 0);
          const total = HORAS.length * MAX_CUPOS;
          if (taken >= total) cell.classList.add("full");
          else if (taken >= total / 2) cell.classList.add("medium");
          cell.onclick = () => { selectCell(cell); showSlots(iso); };
        }
        cal.appendChild(cell);
      }
    }
    function disabledCell() { const d = document.createElement("div"); d.className = "day disabled"; return d; }
    let lastSelected = null;
    function selectCell(el) { if (lastSelected) lastSelected.classList.remove("selected"); lastSelected = el; el.classList.add("selected"); }

    function showSlots(iso) {
      const cont = $("slots"); cont.innerHTML = "";
      const occ = reservas[iso] || {};
      HORAS.forEach(h => {
        const b = document.createElement("button");
        b.className = "slot-btn"; b.textContent = h;
        if ((occ[h] || 0) >= MAX_CUPOS) b.disabled = true;
        b.onclick = () => confirmar(iso, h);
        cont.appendChild(b);
      });
    }

    function confirmar(fecha, hora) {
      const bg = document.createElement("div"); bg.className = "modal-bg";
      bg.innerHTML = `
    <div class="modal">
      <h3>Confirma tu cita</h3>
      <p><b>Nombre:</b> ${user.nombre}</p>
      <p><b>Correo:</b> ${user.correo}</p>
      <p><b>Fecha:</b> ${fecha}</p>
      <p><b>Hora:</b> ${hora}</p>
      <button class="btn-ok">Aceptar</button>
      <button class="btn-cancel">Cancelar</button>
    </div>`;
      bg.querySelector(".btn-cancel").onclick = () => bg.remove();
      bg.querySelector(".btn-ok").onclick = () => { bg.remove(); guardar(fecha, hora); };
      document.body.appendChild(bg);
    }

    async function guardar(fecha, hora) {
      $("spinner").style.display = "block";
      try {

        const ref = db.doc(`slots/${fecha}_${hora}`);
        await db.runTransaction(async tx => {
          const snap = await tx.get(ref);
          const lista = snap.exists ? (snap.data().correos || []) : [];
          if (lista.includes(user.correo)) throw new Error("Ya tienes cita en ese horario");
          if (lista.length >= MAX_CUPOS) throw new Error("Horario lleno");
          lista.push(user.correo);
          tx.set(ref, { correos: lista }, { merge: true });
        });


        fetch(EXT_URL, {
          method: "POST",
          mode: "no-cors",
          body: new URLSearchParams({
            Empleado: user.empleado || "",
            Rol: user.rol || "",
            Nomina: user.nomina || "",
            Nombre: user.nombre,
            Correo: user.correo,
            Fecha: fecha,
            Hora: hora
          })
        });

        alert("✅ Cita registrada con éxito");
        await refrescarReservas(); render();
      } catch (e) {
        alert("❌ " + (e.message || "Error al guardar"));
      } finally {
        $("spinner").style.display = "none";
      }
    }

    async function refrescarReservas() {
      reservas = {};
      const s = await db.collection("slots").get();
      s.forEach(doc => {
        const [f, h] = doc.id.split("_");
        reservas[f] ??= {};
        reservas[f][h] = (doc.data().correos || []).length;
      });
    }
    function generarHoras(start, end, step) {
      const out = []; let [h, m] = start.split(":").map(Number); const [eh, em] = end.split(":").map(Number);
      while (h < eh || (h === eh && m <= em)) {
        out.push(`${pad(h)}:${pad(m)}`); m += step; if (m >= 60) { h++; m -= 60; }
      } return out;
    }

    function mostrarAviso() {
      fetch("docs/aviso.txt")
        .then(r => { if (!r.ok) throw 0; return r.text(); })
        .then(t => { $("avisoTexto").textContent = t; $("modalAviso").style.display = "flex"; })
        .catch(_ => { $("avisoTexto").textContent = "No se pudo cargar el aviso."; $("modalAviso").style.display = "flex"; });
    }
    function cerrarAviso() { $("modalAviso").style.display = "none"; }
  </script>

  <div id="modalAviso" class="modal-bg" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <h3>Aviso de Privacidad</h3>
        <button class="close-modal" onclick="cerrarAviso()">✖</button>
      </div>
      <div class="modal-scroll">
        <pre id="avisoTexto" style="white-space:pre-line;font-family:inherit;"></pre>
      </div>
    </div>
  </div>

</body>

</html>
